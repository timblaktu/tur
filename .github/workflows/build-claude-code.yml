name: Build claude-code

on:
  push:
    branches:
      - master
      - main
      - dev
    paths:
      - 'tur/claude-code/**'
      - '.github/workflows/build-claude-code.yml'
  pull_request:
    paths:
      - 'tur/claude-code/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: 'false'

permissions:
  contents: write  # Needed for GitHub Pages deployment and releases

jobs:
  build:
    name: Build claude-code package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Platform-independent package (npm handles platform details)
        arch: [all]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # LTS version

      - name: Set up build environment
        run: |
          # Install Debian packaging tools
          sudo apt-get update
          sudo apt-get install -y \
            dpkg-dev \
            debhelper \
            build-essential

      - name: Build package
        id: build
        run: |
          cd tur/claude-code

          # Extract version info from build.sh
          PKG_NAME="claude-code"
          VERSION=$(grep '^TERMUX_PKG_VERSION=' build.sh | cut -d= -f2)
          REVISION=$(grep '^TERMUX_PKG_REVISION=' build.sh | cut -d= -f2)
          ARCH="all"
          PKG_DIR="${PKG_NAME}_${VERSION}-${REVISION}"

          echo "Building ${PKG_NAME} version ${VERSION}-${REVISION}"

          # Create package directory structure
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/data/data/com.termux/files/usr/bin"
          mkdir -p "${PKG_DIR}/data/data/com.termux/files/usr/lib/node_modules"
          mkdir -p "${PKG_DIR}/data/data/com.termux/files/usr/share/doc/claude-code"

          # Install Claude Code via npm to temporary location
          TEMP_NPM_PREFIX="$(pwd)/npm-temp"
          mkdir -p "$TEMP_NPM_PREFIX"

          echo "Installing @anthropic-ai/claude-code from npm..."
          npm install -g --prefix "$TEMP_NPM_PREFIX" @anthropic-ai/claude-code

          # Verify installation succeeded
          if [ ! -d "$TEMP_NPM_PREFIX/lib/node_modules/@anthropic-ai/claude-code" ]; then
            echo "ERROR: npm installation failed"
            exit 1
          fi

          # Copy node_modules to package
          echo "Copying installed files to package..."
          cp -r "$TEMP_NPM_PREFIX/lib/node_modules/@anthropic-ai" \
                "${PKG_DIR}/data/data/com.termux/files/usr/lib/node_modules/"

          # Create symlink for the binary
          # Note: In the actual .deb, this will be a relative symlink
          CLAUDE_BIN="${PKG_DIR}/data/data/com.termux/files/usr/bin/claude"
          CLAUDE_TARGET="../lib/node_modules/@anthropic-ai/claude-code/bin/claude.js"

          # Create the symlink (relative path)
          ln -sf "$CLAUDE_TARGET" "$CLAUDE_BIN"

          # Copy README
          install -m644 README.md "${PKG_DIR}/data/data/com.termux/files/usr/share/doc/claude-code/"

          # Generate control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: claude-code
          Version: ${VERSION}-${REVISION}
          Architecture: ${ARCH}
          Maintainer: Tim Blaktu <timblaktu@users.noreply.github.com>
          Depends: nodejs-lts
          Suggests: claude-wrappers
          Description: Official Anthropic CLI for Claude
           Claude Code is the official command-line interface for Claude AI.
           This package installs Claude Code via npm and provides the 'claude'
           command for Termux.
           .
           Features:
           - Interactive and single-prompt modes
           - File and pipe input support
           - Multi-account support via claude-wrappers package
           .
           Install claude-wrappers for multi-account management.
          Homepage: https://github.com/anthropics/claude-code
          EOF

          # Create postinst script
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'POSTINST_EOF'
          #!/data/data/com.termux/files/usr/bin/sh
          echo ""
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║  Claude Code Installed                                         ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Claude Code is now available via the 'claude' command."
          echo ""
          echo "Quick start:"
          echo "  claude              - Interactive mode"
          echo "  claude \"help me\"    - Single prompt"
          echo "  claude --help       - Show all options"
          echo ""
          echo "Configuration:"
          echo "  Claude Code stores config in ~/.claude/ directory"
          echo ""
          echo "Multi-account setup:"
          echo "  Install claude-wrappers for account switching:"
          echo "  pkg install claude-wrappers"
          echo ""
          echo "Documentation:"
          echo "  \$PREFIX/share/doc/claude-code/README.md"
          echo "  https://docs.anthropic.com/claude-code"
          echo ""
          POSTINST_EOF

          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          # Create prerm script (warn about claude-wrappers dependency)
          cat > "${PKG_DIR}/DEBIAN/prerm" << 'PRERM_EOF'
          #!/data/data/com.termux/files/usr/bin/sh
          # Check if claude-wrappers is installed
          if dpkg -l claude-wrappers 2>/dev/null | grep -q '^ii'; then
            echo ""
            echo "╔════════════════════════════════════════════════════════════════╗"
            echo "║  WARNING: claude-wrappers installed                           ║"
            echo "╚════════════════════════════════════════════════════════════════╝"
            echo ""
            echo "The claude-wrappers package depends on claude-code."
            echo "Removing claude-code will break claudemax, claudepro, claudework."
            echo ""
            echo "Consider removing claude-wrappers first:"
            echo "  pkg remove claude-wrappers"
            echo ""
            read -p "Continue removing claude-code? [y/N] " -n 1 -r
            echo
            if [[ ! \$REPLY =~ ^[Yy]\$ ]]; then
              exit 1
            fi
          fi
          exit 0
          PRERM_EOF

          chmod 755 "${PKG_DIR}/DEBIAN/prerm"

          # Build .deb package
          echo "Building .deb package..."
          dpkg-deb --build "${PKG_DIR}"

          # Get actual Claude Code version from npm
          CLAUDE_VERSION=$(npm view @anthropic-ai/claude-code version)
          echo "Package version: ${VERSION}-${REVISION}"
          echo "Claude Code npm version: ${CLAUDE_VERSION}"

          # Save output info
          echo "package_file=${PKG_DIR}.deb" >> $GITHUB_OUTPUT
          echo "version=${VERSION}-${REVISION}" >> $GITHUB_OUTPUT
          echo "claude_version=${CLAUDE_VERSION}" >> $GITHUB_OUTPUT

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-code-all
          path: tur/claude-code/*.deb
          retention-days: 30

  publish:
    name: Publish to APT repository
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout gh-pages (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo
        continue-on-error: true  # First deployment won't have gh-pages yet

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create/Update repository structure
        run: |
          # Create repository directory structure
          mkdir -p repo/dists/stable/main/binary-all

          # Copy new package
          cp artifacts/claude-code-all/*.deb repo/dists/stable/main/binary-all/ || true

          cd repo

          # Generate Packages file
          dpkg-scanpackages dists/stable/main/binary-all /dev/null | \
            gzip -9c > dists/stable/main/binary-all/Packages.gz

          # Generate Release file
          cat > dists/stable/Release << EOF
          Origin: timblaktu-tur
          Label: Tim's TUR Packages
          Suite: stable
          Codename: stable
          Architectures: all aarch64 arm i686 x86_64
          Components: main
          Description: Personal Termux packages (Claude Code and wrappers)
          Date: $(date -R)
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          keep_files: true  # Keep existing packages (claude-wrappers)
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: claude-code-${{ needs.build.outputs.version }}
          name: Claude Code ${{ needs.build.outputs.version }}
          body: |
            ## Claude Code for Termux

            Official Anthropic CLI for Claude, packaged for Termux.

            **Package version**: ${{ needs.build.outputs.version }}
            **Claude Code version**: ${{ needs.build.outputs.claude_version }}

            ## Installation

            ```bash
            # Add repository (if not already added)
            echo "deb [trusted=yes] https://timblaktu.github.io/tur stable main" | \
              tee $PREFIX/etc/apt/sources.list.d/timblaktu-tur.list

            # Update and install
            pkg update
            pkg install claude-code

            # Verify installation
            claude --version
            ```

            ## Quick Start

            ```bash
            # Interactive mode
            claude

            # Single prompt
            claude "help me with bash scripting"

            # Show help
            claude --help
            ```

            ## Multi-Account Support

            For managing multiple Claude accounts (Max, Pro, Work), install the companion package:

            ```bash
            pkg install claude-wrappers
            ```

            See the [README](https://github.com/timblaktu/nixcfg/tree/main/tur-package/claude-code/README.md) for full documentation.

            ## What's New

            - npm-based installation of Claude Code
            - Automatic dependency on nodejs-lts
            - Integration with claude-wrappers package
            - Comprehensive documentation
          files: artifacts/claude-code-all/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
