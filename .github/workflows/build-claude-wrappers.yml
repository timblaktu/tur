name: Build claude-wrappers

on:
  push:
    branches:
      - master
      - main
      - dev
    paths:
      - 'tur/claude-wrappers/**'
      - '.github/workflows/build-claude-wrappers.yml'
  pull_request:
    paths:
      - 'tur/claude-wrappers/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: 'false'

permissions:
  contents: write  # Needed for GitHub Pages deployment

jobs:
  build:
    name: Build claude-wrappers package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Platform-independent package, but build for all architectures
        # for consistency with TUR infrastructure
        arch: [all]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1000

      - name: Set up build environment
        run: |
          # Install termux-packages build dependencies
          sudo apt-get update
          sudo apt-get install -y \
            dpkg-dev \
            debhelper \
            build-essential

      - name: Build package
        id: build
        run: |
          # Since this is a platform-independent package with SKIP_SRC_EXTRACT,
          # we can build it directly without the full termux-packages Docker setup

          cd tur/claude-wrappers

          # Create package directory structure
          PKG_NAME="claude-wrappers"
          VERSION=$(grep '^TERMUX_PKG_VERSION=' build.sh | cut -d= -f2)
          REVISION=$(grep '^TERMUX_PKG_REVISION=' build.sh | cut -d= -f2)
          ARCH="all"
          PKG_DIR="${PKG_NAME}_${VERSION}-${REVISION}"

          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/data/data/com.termux/files/usr/bin"
          mkdir -p "${PKG_DIR}/data/data/com.termux/files/usr/share/doc/claude-wrappers"

          # Generate control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: claude-wrappers
          Version: ${VERSION}-${REVISION}
          Architecture: ${ARCH}
          Maintainer: Tim Blaktu <timblaktu@users.noreply.github.com>
          Depends: bash
          Suggests: nodejs-lts
          Description: Claude Code multi-account wrapper scripts for Termux
           Provides wrapper scripts for managing multiple Claude Code accounts:
           - claudemax:  Claude Max account
           - claudepro:  Claude Pro account
           - claudework: Custom proxy template (requires configuration)
           .
           Each wrapper sets up account-specific configuration and launches
           Claude Code with proper environment variables.
          Homepage: https://github.com/timblaktu/nixcfg
          EOF

          # Copy files
          install -m755 claudemax "${PKG_DIR}/data/data/com.termux/files/usr/bin/"
          install -m755 claudepro "${PKG_DIR}/data/data/com.termux/files/usr/bin/"
          install -m755 claudework "${PKG_DIR}/data/data/com.termux/files/usr/bin/"
          install -m755 claude-setup-work "${PKG_DIR}/data/data/com.termux/files/usr/bin/"
          install -m644 README.md "${PKG_DIR}/data/data/com.termux/files/usr/share/doc/claude-wrappers/"

          # Create postinst script
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'POSTINST_EOF'
          #!/data/data/com.termux/files/usr/bin/sh
          echo ""
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║  Claude Code Wrappers Installed                                ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Available commands:"
          echo "  claudemax   - Claude Max account"
          echo "  claudepro   - Claude Pro account"
          echo "  claudework  - Custom proxy template"
          echo ""
          echo "To configure claudework for your proxy:"
          echo "  1. Edit: \$PREFIX/bin/claudework"
          echo "  2. Run: claude-setup-work"
          echo ""
          echo "Documentation:"
          echo "  \$PREFIX/share/doc/claude-wrappers/README.md"
          echo ""
          echo "Note: Claude Code must be installed separately."
          echo "      Install with: npm install -g @anthropic/claude-code"
          echo ""
          POSTINST_EOF

          chmod 755 "${PKG_DIR}/DEBIAN/postinst"

          # Build .deb package
          dpkg-deb --build "${PKG_DIR}"

          # Save output info
          echo "package_file=${PKG_DIR}.deb" >> $GITHUB_OUTPUT
          echo "version=${VERSION}-${REVISION}" >> $GITHUB_OUTPUT

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: claude-wrappers-all
          path: tur/claude-wrappers/*.deb
          retention-days: 30

  publish:
    name: Publish to APT repository
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create repository structure
        run: |
          # Create repository directory structure
          mkdir -p repo/dists/stable/main/binary-all
          cp artifacts/claude-wrappers-all/*.deb repo/dists/stable/main/binary-all/ || true

          cd repo

          # Generate Packages file
          dpkg-scanpackages dists/stable/main/binary-all /dev/null | \
            gzip -9c > dists/stable/main/binary-all/Packages.gz

          # Generate Release file
          cat > dists/stable/Release << EOF
          Origin: timblaktu-tur
          Label: Tim's TUR Packages
          Suite: stable
          Codename: stable
          Architectures: all aarch64 arm i686 x86_64
          Components: main
          Description: Personal Termux packages (Claude Code wrappers)
          Date: $(date -R)
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: claude-wrappers-${{ needs.build.outputs.version }}
          name: Claude Wrappers ${{ needs.build.outputs.version }}
          body: |
            ## Installation

            ```bash
            # Add repository
            echo "deb [trusted=yes] https://timblaktu.github.io/tur stable main" | \
              tee $PREFIX/etc/apt/sources.list.d/timblaktu-tur.list

            # Update and install
            pkg update
            pkg install claude-wrappers
            ```

            ## What's Included

            - `claudemax` - Claude Max account wrapper
            - `claudepro` - Claude Pro account wrapper
            - `claudework` - Custom proxy template wrapper
            - `claude-setup-work` - Interactive setup helper

            See the [README](https://github.com/timblaktu/nixcfg/tree/main/tur-package/claude-wrappers/README.md) for full documentation.
          files: artifacts/claude-wrappers-all/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
